on:
  schedule:
    # Run every hour to check for new versions
    - cron: '0 * * * *'
  workflow_dispatch:

name: Excavator

jobs:
  excavate:
    name: Check for Updates
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@main
        with:
          fetch-depth: 0

      - name: Check for new versions
        id: excavator
        uses: ScoopInstaller/GithubActions@main
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SKIP_UPDATED: '1'

      - name: Capture excavator errors
        id: capture-errors
        shell: pwsh
        run: |
          # Check if excavator step failed
          $excavatorResult = "${{ steps.excavator.outcome }}"
          Write-Host "=== Excavator Results ===" -ForegroundColor Cyan
          Write-Host "Excavator outcome: $excavatorResult" -ForegroundColor Gray

          $brokenManifests = @()

          # If excavator failed, try to identify which manifests had issues
          if ($excavatorResult -eq 'failure') {
            # Check for modified manifests (those that excavator tried to update)
            $modifiedManifests = @(git diff --name-only HEAD | Where-Object { $_ -match '^bucket/.*\.json$' })

            if ($modifiedManifests.Count -gt 0) {
              Write-Host "Modified manifests: $($modifiedManifests.Count)" -ForegroundColor Yellow
              $brokenManifests = $modifiedManifests | ForEach-Object { (Split-Path -LeafBase $_) }
            } else {
              # If no modifications found, get all base manifests to check
              $allManifests = @(Get-ChildItem -Path "bucket" -Filter "*.json" -File | Where-Object { $_.Name -notmatch '(-nightly|-dev)' } | Select-Object -ExpandProperty BaseName)
              Write-Host "No specific manifests identified, will check all: $($allManifests.Count)" -ForegroundColor Yellow
              $brokenManifests = $allManifests
            }

            # Save broken manifests list to file for next step
            $brokenManifests | ConvertTo-Json | Out-File -FilePath "broken-manifests.json" -Encoding UTF8
            Write-Host "Saved error manifest list to broken-manifests.json" -ForegroundColor Green

            # Output as GitHub Actions output
            "broken-manifests=$($brokenManifests -join ',')" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding UTF8 -Append
            "has-errors=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding UTF8 -Append

            Write-Host "Error manifests identified: $($brokenManifests -join ', ')" -ForegroundColor Red
            exit 1
          } else {
            Write-Host "[OK] Excavator completed successfully" -ForegroundColor Green
            "has-errors=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding UTF8 -Append
            exit 0
          }

      - name: Upload broken manifests list
        if: steps.capture-errors.outputs.has-errors == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: broken-manifests
          path: broken-manifests.json
          retention-days: 1
